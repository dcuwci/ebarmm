# E-BARMM Docker Compose - Staging Environment
# Uses: Native PostgreSQL on EC2 + AWS S3 for media storage
# Only containerizes: Backend, Frontend, Redis

version: '3.8'

services:
  # FastAPI Backend
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: ebarmm-backend
    environment:
      # Database - connects to native PostgreSQL on host
      DATABASE_URL: postgresql+psycopg://${DB_USER}:${DB_PASSWORD}@host.docker.internal:5432/${DB_NAME}

      # Redis - containerized
      REDIS_URL: redis://redis:6379/0

      # AWS S3 - replaces MinIO
      S3_ENDPOINT: https://s3.${AWS_REGION}.amazonaws.com
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET: ${S3_BUCKET}
      S3_REGION: ${AWS_REGION}
      S3_USE_SSL: "true"

      # Security
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}

      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS}

      # Environment
      DEBUG: "false"
      ENVIRONMENT: staging
      LOG_LEVEL: INFO

      # MFA
      MFA_ENABLED: "true"
      MFA_REQUIRED: "false"
    ports:
      - "8000:8000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - ebarmm-network
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # React Frontend (served by Nginx)
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ""
    container_name: ebarmm-frontend
    ports:
      - "80:80"
    networks:
      - ebarmm-network
    depends_on:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis (for token blacklist - ephemeral data, OK in Docker)
  redis:
    image: redis:7-alpine
    container_name: ebarmm-redis
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    ports:
      - "127.0.0.1:6379:6379"  # Only accessible from localhost
    networks:
      - ebarmm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  ebarmm-network:
    driver: bridge

volumes:
  redis-data:
